// Updated dashboard JavaScript
const loadBtn = document.getElementById('loadBtn');
const scriptIdInput = document.getElementById('scriptId');
const apiUrlInput = document.getElementById('apiUrl');
const statsGrid = document.getElementById('statsGrid');
const usersList = document.getElementById('usersList');

let autoRefreshInterval = null;

async function loadData() {
    const scriptId = scriptIdInput.value.trim() || 'default';
    const apiUrl = apiUrlInput.value.trim().replace(/\/$/, '');
    
    // Show loading
    statsGrid.innerHTML = '<div class="stat-card"><div class="loading">Loading...</div></div>';
    usersList.innerHTML = '<div class="loading">Loading user data...</div>';
    
    try {
        const response = await fetch(`${apiUrl}/api/status?scriptId=${scriptId}&detailed=true`);
        if (!response.ok) throw new Error(`API Error: ${response.status}`);
        
        const data = await response.json();
        if (!data.success) throw new Error(data.error || 'Unknown error');
        
        updateStats(data.data);
        updateUsersList(data.data);
        
        // Auto-refresh every 10 seconds
        if (!autoRefreshInterval) {
            autoRefreshInterval = setInterval(loadData, 10000);
        }
        
    } catch (error) {
        console.error('Error:', error);
        statsGrid.innerHTML = `<div class="error"><strong>Error:</strong> ${error.message}</div>`;
        usersList.innerHTML = `<div class="error"><strong>Error:</strong> ${error.message}<p>Check API URL and Script ID</p></div>`;
        
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }
}

function updateStats(data) {
    const lastUpdate = new Date(data.timestamp).toLocaleTimeString();
    const activeUsers = data.detailedUsers?.filter(user => user.secondsAgo < 30).length || 0;
    
    statsGrid.innerHTML = `
        <div class="stat-card">
            <div class="stat-label">Online Users</div>
            <div class="stat-value">${data.onlineCount}</div>
            <div class="stat-label">Real-time</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-label">Active Now</div>
            <div class="stat-value">${activeUsers}</div>
            <div class="stat-label">Last 30 seconds</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-label">Script ID</div>
            <div class="stat-value" style="font-size: 1.6rem;">${data.scriptId}</div>
            <div class="stat-label">Updated: ${lastUpdate}</div>
        </div>
    `;
}

function updateUsersList(data) {
    if (!data.detailedUsers || data.detailedUsers.length === 0) {
        usersList.innerHTML = `
            <div class="users-header">
                <h3>Online Users</h3>
                <span class="user-count">0 users</span>
            </div>
            <div class="loading">No users currently online</div>
        `;
        return;
    }
    
    // Sort by last active (newest first)
    const sortedUsers = [...data.detailedUsers].sort((a, b) => b.lastActive - a.lastActive);
    
    let usersHTML = `
        <div class="users-header">
            <h3>Online Users</h3>
            <span class="user-count">${sortedUsers.length} users</span>
        </div>
        <div class="user-cards">
    `;
    
    sortedUsers.forEach(user => {
        const lastSeen = new Date(user.lastActive).toLocaleTimeString();
        const isActive = user.secondsAgo < 30;
        const statusClass = isActive ? 'status-online' : '';
        const statusText = isActive ? 'Active now' : `${user.secondsAgo}s ago`;
        
        // Format uptime
        const uptime = user.uptimeSeconds || 0;
        const uptimeText = uptime >= 60 
            ? `${Math.floor(uptime / 60)}m ${uptime % 60}s` 
            : `${uptime}s`;
        
        usersHTML += `
            <div class="user-card">
                <div class="user-id">
                    <span class="status-indicator ${statusClass}"></span>
                    ${user.userInfo?.playerName || user.userId?.substring(0, 12) || 'Unknown'}
                </div>
                
                <!-- BASIC INFO -->
                <div class="user-info">
                    <strong>Session:</strong> ${user.sessionId?.substring(0, 8) || 'N/A'}...
                </div>
                <div class="user-info">
                    <strong>Status:</strong> ${statusText}
                </div>
                <div class="user-info">
                    <strong>Uptime:</strong> ${uptimeText}
                </div>
                <div class="user-info">
                    <strong>Heartbeats:</strong> ${user.heartbeatCount || 1}
                </div>
                
                <!-- EXPANDABLE DETAILS -->
                <details class="user-details">
                    <summary>ðŸ“‹ Show Details</summary>
                    
                    ${user.userInfo?.playerId ? `
                    <div class="user-detail">
                        <strong>Player ID:</strong> ${user.userInfo.playerId}
                    </div>
                    ` : ''}
                    
                    ${user.userInfo?.profileUrl ? `
                    <div class="user-detail">
                        <strong>Profile:</strong> 
                        <a href="${user.userInfo.profileUrl}" target="_blank" class="profile-link">
                            ${user.userInfo.profileUrl.replace('https://www.roblox.com/users/', '')}
                        </a>
                    </div>
                    ` : ''}
                    
                    ${user.userInfo?.executor ? `
                    <div class="user-detail">
                        <strong>Executor:</strong> ${user.userInfo.executor}
                    </div>
                    ` : ''}
                    
                    ${user.userInfo?.jobId ? `
                    <div class="user-detail">
                        <strong>Job ID:</strong> ${user.userInfo.jobId}
                    </div>
                    ` : ''}
                    
                    ${user.userInfo?.placeId ? `
                    <div class="user-detail">
                        <strong>Place ID:</strong> ${user.userInfo.placeId}
                    </div>
                    ` : ''}
                    
                    ${user.userInfo?.scriptName ? `
                    <div class="user-detail">
                        <strong>Script:</strong> ${user.userInfo.scriptName}
                    </div>
                    ` : ''}
                    
                    <div class="user-detail">
                        <strong>Last seen:</strong> ${lastSeen}
                    </div>
                </details>
            </div>
        `;
    });
    
    usersHTML += `</div>`;
    usersList.innerHTML = usersHTML;
}

// Add some CSS for the new details section
const style = document.createElement('style');
style.textContent = `
    .user-details {
        margin-top: 8px;
        border-top: 1px solid #eee;
        padding-top: 8px;
    }
    
    .user-details summary {
        cursor: pointer;
        color: #667eea;
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 5px;
    }
    
    .user-details summary:hover {
        color: #764ba2;
    }
    
    .user-detail {
        font-size: 0.85rem;
        color: #666;
        margin: 3px 0;
        word-break: break-all;
    }
    
    .profile-link {
        color: #3498db;
        text-decoration: none;
    }
    
    .profile-link:hover {
        text-decoration: underline;
    }
`;
document.head.appendChild(style);

// Event listeners
loadBtn.addEventListener('click', loadData);

// Auto-load on page load
window.addEventListener('DOMContentLoaded', () => {
    const currentUrl = window.location.origin;
    if (currentUrl.includes('vercel.app')) {
        apiUrlInput.value = currentUrl;
    }
    // Pre-fill with your script ID
    scriptIdInput.value = 'bigratmonster';
    loadData();
});

// Stop auto-refresh when page is hidden
document.addEventListener('visibilitychange', () => {
    if (document.hidden && autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    } else if (!document.hidden) {
        loadData();
    }
});
